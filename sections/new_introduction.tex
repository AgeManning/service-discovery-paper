%!TEX root = ../main.tex
%=========================================================

\section{Introduction}
\para{Motivation} Ethereum~\cite{buterin2013ethereum}  is one of the largest permissionless,  open-source  blockchains supporting Turing-complete scripting via smart contracts. Ethereum runs a Peer-to-Peer (P2P) network based on Kademlia Distributed Hash Table (DHT) ~\cite{maymounkov2002kademlia} to exchange pending transactions and mined blocks. 

Apart from supporting blockchain data exchange, the Ethereum P2P network is used by other applications. This includes multiple Ethereum testnets (Rinkeby, Ropsten), decentralized application (iExec, Swarm, Whisper) or alternative cryptocurrencies (Pirl, Musicoin). In 2018, the Ethereum P2P network nodes operated a total of 4,076 different applications~\cite{kim2018measuring}. 
\michal{It'd be good to say why Ethereum wants to have a common P@P network for many applications.}

Regardless of supported applications, all the nodes on the network must also run the Ethereumâ€™s P2P communication protocol suite (DEVp2p) and join the Ethereum Distributed Hash Table (DHT). DEVp2p includes individual sub-systems and protocols for various network-level services for peers to use such as initializing DHT routing tables and establishing secure communication with the DHT peers. Nodes can then form application-specific P2P networks confining the dissemination of their application-specific messages (\eg event notifications) to only the interested peers.



\para{State of the art} To form an application-specific P2P network, its participants must first find each other among nodes who do not support the application. In the current service discovery system of Ethereum---\ie discovery version 4 (Discv4)---nodes perform a \textit{brute-force} discovery process. A node willing to discover application-specific peers randomly traverses the DHT and initiates connections with all the encountered nodes. A permanent connection is established only if a peer supports the same application and terminated otherwise. Such an approach results in large communication overhead and long discovery time, particularly for less popular applications with small number of peers.

Unlike existing discovery protocols that work in a local setting (MDNS/Bonjour) or rely on centralisation and trusted operators (\eg rendezvous servers in pub-sub systems~\cite{}), node discovery in Ethereum must work at large scale (in the global Internet) and in a completely decentralised setting  (\ie a trust-less environment). 

\para{Discv5} In this work, we propose the discovery system version 5 (\textit{\sysname}) --- a \textbf{service discovery sub-system} which enables secure and robust discovery of application-specific peers in the Ethereum network. Different from the current system, \sysname allows nodes to associate themselves with a set of tags, i.e., \textit{``topics''}, and advertise the association to the network \ie  \textbf{registering an \emph{ad}}. The information is collectively stored in the network and does not rely on any single trusted party. Any node can then query (\ie lookup) the network for a topic to obtain a list of application-specific peers and directly connect to them without bothering other members of the network. 

\michal{From the paragraph below we should form a requirements parts}
To serve its purpose, \sysname must be efficient and introduce lower overhead than previous, random walk-based approach. An open and decentralized discovery system introduces new security challenges that need to be addressed. Malicious nodes may decide to deviate from the protocol in order to increase their own visibility or disrupt system operations. A particularly important security challenge is the \textit{Sybil attack} which can amplify the attacking power of malicious nodes, typically with very little resource consumption. The Sybils can launch various attacks including Denial-of-Service (DoS) by ignoring ad lookups, spam ads with bogus topic advertisement, and launch more sophisticated attacks to isolate nodes from their peers in their target sub-networks (\ie eclipse attack). 
\michal{The above needs completion}

We build \sysname on top of the existing Ethereum DHT to avoid major changes to the infrastructure and take advantage of already existing routing infrastructure. The system propagates application-specific advertisements to multiple nodes chosen in an unpredictable way to protect against targeted attacks and network dynamics. At the same time, \sysname provides efficient ad discovery operations terminating within a bounded number of steps for all the applications regardless of their popularity.

\para{Contributions} We make the following contributions:
\michal{Maybe we should have 3 main contributions: 1) placement of adds + lookup 2) the protocol with tickets etc. 3) waiting function. We could organize the main section based on that.}
\begin{itemize}
    \item In \Cref{sec:registration_multi}, we design a DHT-based data placement system that distributes service advertisement in the network. The protocol combines pseudo-random data placement for security with deterministic placement to facilitate lookup operations. 
    \item In \Cref{sec:lookup}, we present a lookup operation that finds a subset of advertisement placed in the system within a bounded amount of time. The procedure ensure the diversity of data sources and is resistant against manipulation by malicious actors. 
    \item In \Cref{sec:registration_single} we design a lightweight protocol allowing advertisers to place ads after waiting for a specified amount of time. The protocol guarantees that advertisers cannot place more advertisement by deviating from the protocol and does not create any intermediary state at nodes holding the advertisements. 
    \item In \Cref{sec:waitingTime}, we design a function that calculates a waiting time after which advertisement can be placed on nodes holding advertisements. The function limits the amount of resources used by each node, promotes ads diversity stored within nodes, and protects against a vast range of malicious behaviours. 
\end{itemize}

We evaluate \sysname under different system parameters and against state-of-the-art decentralised discovery systems. Our system achieves better load-balancing and requires more resource consumption by the attackers to successfully launch attacks such as eclipsing attacks. We also provide performance evaluation results from both simulations and from real system deployment. \sysname is scheduled for implementation in the next version of the Ethereum P2P network. 

