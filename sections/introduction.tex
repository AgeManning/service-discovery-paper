%!TEX root = ../main.tex
%=========================================================

\section{Introduction}

Ethereum~\cite{} is a decentralized, open-source blockchain for distributed computing, allowing users to develop various decentralized applications (DApps). Being the first major blockchain to support Turing-complete scripting via smart contracts, Ethereum supports transfer of any fungible token and also has its own native crypto-currency called ether. In addition to its use as a fiat currency,  ether is also used to incentivize Ethereum nodes to perform distributed computation. 

%Ethereum is the most actively used blockchain~\cite{bloomberg} nowadays.
%Following its decentralized design and structure, Ethereum relies on a communication infrastructure provided by a peer-to-peer (P2P) network, where individual and independent nodes, running an Ethereum client software (e.g., Go Ethereum~\cite{go-ethereum}), send and receive messages  containing transactions and blocks to achieve distributed consensus,  without relying on any central node or a trusted third party.

%Ethereum~\cite{} is a popular, permission-less blockchain for decentralised computing, allowing users to develop various decentralized applications (DApps). DApps can be programmed using a Turing-complete language smart contracts that are executed on the Ethereum Virtual Machine (EVM). While smart contracts can support transfer of any fungible token, Ethereum has a native currency called ether which can be transferred between Ethereum accounts. Ether is also used to incentivize execution of distributed computations on the Blockchain---\ie running an operation (\eg token transaction) on Ethereum requires payment of a ``gas fee'', proportional to the amount of computational effort required to execute the operation. Gas fees effectively mitigate abuse of resources and spamming of transactions by malicious actors.  
%is currently the most actively used Blockchain~\cite{bloomberg}. 

Following its decentralized design, Ethereum relies on a Peer-to-Peer (P2P) communication network, where individual nodes, running an Ethereum client software (\eg Go Ethereum~\cite{go-ethereum}), send and receive messages containing transactions and blocks to achieve distributed consensus, without relying on any central node or a trusted third party. The core system and the associated protocols used by the peers to participate in the Ethereum P2P network is included as part of a suite called DEVp2p. This suite includes individual sub-systems and protocols for services such as node discovery, establishing secure or transport-level communication between peers. 

\michal{It'd be good to say why Ethereum wants to have a common P@P network for many applications.}
Regardless of whether they use the Ethereum blockchain or not, many decentralised, networked, application services---\eg Swarm (file storage)~\cite{}, iExec (computation offloading)~\cite{}, and so on---can participate in the Ethereum network to take advantage of DEVp2p functionality, most notably its node discovery sub-system. Node discovery enables discovery of peers to form a service-specific sub-network of interest (\eg peers joining the Swarm network) and to maintain connections to live nodes in those sub-networks. By forming these dedicated subnetworks, each service confines the dissemination of its messages (\eg event notifications) to only the interested peers.

Unlike existing discovery protocols that work in a local setting (MDNS/Bonjour) or rely on centralisation and trusted operators (\eg rendezvous servers in pub-sub systems~\cite{}), node discovery in Ethereum must work at large scale (in the global Internet) and in a completely decentralised setting  (\ie a trust-less environment). 

The current node discovery system of Ethereum---\ie discovery version 4 (Discv4)---uses a Distributed Hash Table (DHT) (Kademlia) to perform searches. Initially, all nodes regardless of their application of interest join the DHT, by default. After joining the DHT, each node then performs a node search process involving random walks (\ie finding the closest node to a random target through iterative find queries starting with the closest, known neighbors in the DHT) in the DHT without specifying a specific service or node characteristc, and performing individual hand-shakes with the discovered nodes (that are come across along the way to the target) to find out if they are part of the application sub-networks of interest. This \emph{brute-force} approach can take very long to find nodes, particularly for unpopular applications (\ie having small number of peers) and can lead to wasteful hand-shakes with many nodes that are not part of the target sub-networks during the discovery process. 

In this paper, we propose and evaluate a new system and the associated protocols for node discovery, \ie the discovery system version 5 (\textit{Discv5}). Different from the current system, Discv5 allows nodes to associate themselves with a set of tags, i.e., \textit{``topics''}, and enable peers advertising themselves as associated with topics of interest. The advertisement involves requesting other peers to locally store a node's ID (hash of its public key) to topic association, \ie  registering an ``ad''. Once stored, ads can be looked up during a search process to find nodes. 

We integrate the search and registration mechanisms of Discv5 with the existing Kademlia DHT to avoid major changes to the infrastructure. The search process in our proposed discovery system returns only the peers that are part of target sub-networks, obviating the handshake mechanism. Also, by targeting ad placements at specific locations in the DHT, the discovery process can be made much more efficient. However, storing ads introduce new challenges in terms of securing the local ad storage at the peers (\ie against misuse or attack) in the presence of malicious nodes and balancing the overhead of discovery across the peers. 

A particularly important security challenge is the Sybil attack which can amplify the attacking power of malicious nodes, typically with very little resource consumption. The Sybils can launch various attacks including Denial-of-Service (DoS) by ignoring lookups, spam ads with bogus topics, and launch more sophisticated attacks to isolate nodes from their peers in their target sub-networks (\ie eclipse attack). Even though Discv5 is layered on top of the Kademlia DHT, our design aims for an independent discovery mechanism which uses the Kademlia layer only for bootstrapping. Therefore, we mainly consider attacks at the discovery layer.
\sergi{Not sure this last sentence is really true. I think use Kademlia DHT to fill up ticket and search tables at any point at time intervals when buckets are empty, not only when bootstraping} 

In an open, decentralised system, where attacks can be neither easily stopped nor detected, the participants have no option other than placing a small amount of trust in every other participant. However, the system must protect shared resources, in particular the storage space for ad placement, making them difficult (\ie resource-consuming) to attack or abuse, while ensuring fair allocation to the peers across different topics under normal circumstances to avoid starvation of unpopular applications. Our system achieves this through a decentralised admission control mechanism which each peer uses to pace the incoming registrations, allocate storage to different topics with varying popularity in a max-min fair manner, and determine which peers' ads to accept. For protection against Sybil attacks, the admission system aims to diversify the peers (in terms of their identifiers) whose ads are stored and similarly the search operations combine results from a diverse set of nodes. 

%In this work, we consider a topic to identify a specific application whose peers form a sub-network that is meant for long-term (on the order of days) usage; albeit, with arbitrary churn of peers~\footnote{Use of topics for discovery of peers in a short-term (minutes or hours) networks, for instance for distributing a particular content identified by a topic, is certainly possible and to be investigated in future work.}.


%In order to find and select participants of the P2P network to initiate connections to,  a node discovery protocol is required by DEVp2p. Systems such as MDNS/Bonjour allow finding hosts,  but only in  a local-area network. However, DEVp2p discovery protocol requires to work on the Internet and to be useful for applications with a large number of participants spread across the Internet. There are systems that uses a rendezvous server for network discovery over the Internet,  such as desktop applications or cloud services. But using rendezvous servers requires trust in the operator and these systems are prone to censorship.  For a decentralized network,  such as the Ethereum network,  it is not desirable to rely on a single operator. Instead,  it is better to place a small amount of trust in every participant, becoming more resistant to censorship as the size of the network increases and participants of multiple networks can share the discovery network to further increase its resilience.
%The process of joining the network is the Achilles heel of the node discovery protocol: while any other node may be used as an entry point,  such a node must first be located through some other mechanism.  
%Approaches such as listing of initial entry points in DNS or discovery of participants in the local network can be used,  but only as a reasonable secure entry into the network.

%Current version of DEVp2p distributed node discovery protocol is discovery version 5 (Discv5). Node discovery protocol can be used by any node on the network  at no cost other than running the network protocol and storing a limited number of other nodes' records. Any node can be used as an entry point into the network. Discv5 system's design is loosely inspired by the Kademlia DHT~\cite{}.
%In Kademlia DHT,  information about known overlay nodes is stored in
%a distributed table separated into so-called k-buckets (or simply buckets),  where each bucket stores nodes identifiers within the same distance to the local node id.
%But unlike most DHTs no arbitrary keys and values are stored. 
%Instead, the DHT stores and relays 'node records', which are signed documents providing information about nodes in the network. 
%Discv5 acts as a database of all live nodes in the network %and performs three basic functions: and,  by walking the DHT,  all nodes of the network can be discovered and enumerated.

%\begin{itemize}
% \item Sampling the set of all live participants: by walking the DHT,  the network can be enumerated.
% \item Searching for participants providing a certain service: Discv5 includes a scalable facility for registering 'topic advertisements'. These advertisements can be queried and nodes advertising a topic found.
% \item Authoritative resolution of node records: if a node's ID is known, the most recent version of its record can be retrieved.
%\end{itemize}

%The concept of topic is a new concept in Discv5 (compared with previous node discovery protocol -Discv4-),  Discv5 will allow nodes to associate themselves with a set of tags, i.e., topics, and enable searching of peers that advertise themselves as associated with particular topics. Topics can be used to identify different  capabilities, for instance specific application capabilities,  services or certain functionalities of a node. \hl{Topics example missing} Topic based peer finding is a promising feature because it allows a potential bandwidth reduction and much faster discovery of nodes by  discovering nodes based on the topic required. This means that instead of connecting to every node discovered to see if it offers a specific service,  a node can simply lookup for nodes that are only providing the service and then ask them if they really are still offering the service. This will avoid a waste of time and resources by leaving apart those nodes that do not declare the service in its capabilities,  avoiding handshakes node by node to discover these details and relying only on the node discovery protocol. 

%However,  Discv5 still lacks of mechanisms to register and discover nodes for specific topics. Providing new mechanisms for registering and discovering for specific topics in Discv5 is challenging because of the decentralized structure of the network and its vulnerability to Sybil attacks~\cite{} (any node joining the network can be a malicious node) adds complexity to any proposed solution that has to work for any kind of service despite its popularity.

%\michal{I'd write the intro on a higher level. E.g., 1) Ethereum is the largest network/blockchain 2) It is fully decentralized and decentralization is great 3) Ethereum allows hosting multiple services other than Ethereum blockchain) and uses Ethereum DHT as a communication/management platform 4) A crucial part of that is to enable nodes working with the same application to find each other 5) this is challenging because of decentralization/security/malicious can join etc. 6) State of the Art doesn't work (briefly - we have better analysis in related work) 7) We propose our brand new shiny protocol that is efficiency and secure 8) Our contributions + structure}


%It is envisioned that the Discv5 system will be used across many different services at large scale, mainly to form subnetworks consisting of the service peers.  The basic objectives of Node Discovery v5 is to provide a facility for nodes to i) register 'topic advertisements', i.e., “ads”, at other peers in the Ethereum network and ii) find other nodes that advertised a particular topic by querying selected peers in the Ethereum network.

%The goal of this paper is to propose and evaluate a new mechanism for the Discv5 protocol for registering and discovery nodes in the network for a certain topic,  integrating it in the existing DEVp2p node discovery protocol based on Kademlia DHT.  
%The new mechanism is capable of registering and discovering for services in the Ethereum P2P network efficiently for any service regardless of the popularity of the service, using a bounded number of hops and resistant to Sybil attacks.
%\hl{Any missing nice feature of the proposal}.

%Our main contributions in this paper are the following:

%\begin{itemize}
%        \item A secure ad placement mechanism that can withstand abuse.
%        \item Efficient search and registration process that can work for unpopular topics.register nodes only for the topics that matches nodes capabilities.
% \item New table structure on top of the existing Kademlia DHT to store node information based on topics advertised.
% \item New lookup mechanism that discover nodes based on the topics advertised in the P2P network.
%\end{itemize}


%The set of network protocols which form the Ethereum P2P network are called DEVp2p. % DEVp2p is not specific to a particular blockchain, but should serve the needs of any networked application associated with the Ethereum umbrella. %%% this is copy-paste from eth docs. 


%Between the DEVp2p network protocols and the app protocol (i.e., Ethereum, Whisper, Swarm, etc), RLPx~\cite{} provides a secure transport layer. 
%\michal{The above seems too detailed IMO. We can introduce DEV2p, RLPx etc. in the background. I'd only say that Ethereum DHT can be used by other services (not necessarily blockchain related) and give some examples.}

%DEVp2p is the responsible of managing the connections to other peers which form the overlay P2P network.
%For instance,  Go-ethereum client by default establish a total of 50  connections to other Ethereum nodes.  Of these 50 slots,  two thirds are reserved for inbound connections (initiated by other peers),  while the remaining third are allocated for outbound connections. 
%No further restrictions apply to inbound connections; if an inbound slot is available
%Go-ethereum client simply accepts any connecting peer that supports the
%Ethereum protocol and operates on the same network (main,
%testing, etc.). 
%The outbound slots are therefore selected by the nodes, which need to be done carefully to avoid any attacker could mount an eclipse attack.
%In an eclipse attack, an
%adversary monopolizes the connections of a victim, effectively
%filtering the victim’s view of the blockchain.  Eclipse attacks
%enable a variety of follow-up attacks such as double spending
%and stubborn mining~\cite{}.
%\michal{ditto}

We evaluate the system under different system parameters and against state-of-the-art decentralised discovery systems. Our system achieves better load-balancing and requires more resource consumption by the attackers to successfully launch attacks such as eclipsing attacks. We also provide performance evaluation results from both simulations and from real system deployment.  
    
The structure of the paper is as follows: In \Cref{sec:background}, we provide a brief summary of Kademlia DHT used by Ethereum. In \Cref{sec:background} we provide some background about Discv4 and existing Ethereum DHT. 
In \Cref{sec:model} we present the system model and assumptions. 
In \Cref{sec:overview} we first describe the overview of the proposed solution and \Cref{sec:design} we detail the design of the system. 
In \Cref{sec:eval} we detail the network performance evaluation and we evaluate the resistance against multiple sybil attacks. 
In \Cref{sec:related} we describe existing related work.
In \Cref{sec:con} we present our conclusions of the paper.